# MySql 中事务的实现

标签（空格分隔）： DB

---

**[原文参考](https://draveness.me/mysql-transaction)**

## 原子性
- 异常和 rollback 时，通过**回滚日志**恢复

## 回滚日志（undo log）
- 在发生错误或者用户执行 ROLLBACK 时提供回滚相关的信息
- 在整个系统发生崩溃、数据库进程直接被杀死后，启动数据库进程时，能够立刻通过回滚日志将之前未完成的事务进行回滚
- - 所以回滚日志必须先于数据持久化到磁盘上
- 回滚日志并不能将数据库物理地恢复到执行语句或者事务之前的样子；它是逻辑日志

## 事务的状态
- 要不就在执行中，要不然就是成功或者失败
- 细分
- - Active：事务的初始状态，表示事务正在执行；
- - Partially Commited：在最后一条语句执行之后；
- - Failed：发现事务无法正常执行之后；
- - Aborted：事务被回滚并且数据库恢复到了事务进行之前的状态之后；
- - Commited：成功执行整个事务；

## 持久性
- 一旦事务被提交，那么数据一定会被写入到数据库中并持久存储起来
- MySQL 使用**重做日志**（redo log）实现事务的持久性

## 重做日志（redo log）
- 重做日志都是以 512 字节的块的形式进行存储的，同时因为块的大小与磁盘扇区大小相同，所以重做日志的写入可以保证原子性，不会由于机器断电导致重做日志仅写入一半并留下脏数据

## 回滚日志和重做日志
- 可以将它们整体看做一条事务日志，其中包含了事务的 ID、修改的行元素以及修改前后的值
- - transaction log (transactionId, element, oldValue, newValue)
- 一条事务日志同时包含了修改前后的值，能够非常简单的进行回滚和重做两种操作

## 隔离性
- 如果事务之间没有隔离性，就会发生在**级联回滚**等问题
- 事务的隔离级别
- 隔离级别的实现
- - 锁
- - 时间戳(PostgreSQL)，用 CAS 操作
- - 多版本和快照隔离(MVCC)。并发时旧版本读，新版本写
- MySQL 中都使用了 MVCC 等特性，也就是正常的读方法是不需要获取锁的，在想要对读取的数据进行更新时需要使用 SELECT ... FOR UPDATE 尝试获取对应行的互斥锁，以保证不同事务可以正常工作。

### 级联回滚（Cascading Rollback）
- 如果没有隔离性，事务 1 会回滚依赖于它的其他事务

## 一致性
- 第一层意思是对于数据完整性的约束，包括主键约束、引用约束等检查，操作应该是合法的
- 第二层意思在代码中写出正确的事务逻辑




