# MySql 索引设计概要

标签（空格分隔）： DB

---

**[原文参考](https://draveness.me/sql-index-intro)**

## 基础知识 
- 索引或行记录是否在缓存池中极大的影响了访问索引或者数据的成本
- 读取所耗费的时间与行数无关，只与页数有关
- 从磁盘上**随机访问**对应的数据非常耗时，所以数据库程序和操作系统提供了**缓冲池**和**内存**以提高数据的访问速度。
- 读取一个页面，需要消耗约 10ms 左右的时间
- - 这 10ms 的一次随机读取是按照每秒 50 次的读取计算得到的，其中等待时间为 3ms、磁盘的实际繁忙时间约为 6ms，最终数据页从磁盘传输到缓冲池的时间为 1ms 左右

## 读取
- 如果在数据库的**缓存池**中没有找到对应的数据页，那么会去**内存**中寻找对应的页面
- - 将 10ms 降低到 1ms
- 读取数据页顺序
- - 数据库的缓冲区 ->  内存 -> 随机 IO 从磁盘中获取

### 顺序读取
- 从磁盘中顺序读取大量的数据时，大概在 40MB/s 左右
- - 如果一个页面的大小为 4KB，那么 1s 的时间就可以读取 10000 个页，读取一个页面所花费的平均时间就是 0.1ms
- - 比内存中读取数据还要快
- 优势
- 1. 同时读取多个界面意味着总时间的消耗会大幅度减少
- 2. 数据库管理程序会对一些即将使用的界面进行**预读**，以减少查询请求的等待和响应时间

## 索引

### 索引片
- SQL 查询在执行过程中扫描的一个索引片段
- 根据索引片包含的列数不同，索引分为宽索引和窄索引
- - 宽索引：包含查询中所需要的全部数据列。能够避免二次的随机 IO
- - 窄索引：也叫半宽索引，没有包含查询中所需要的全部数据列。需要再根据主键 id 从主键索引中查找对应的数据
- - 1. 如果结果集非常大，那么就会导致随机读取的次数过多进而影响性能。

### 过滤因子
- 满足查询条件的记录行数所占的比例
- 当几个过滤条件都是等值谓词时，几个索引列的顺序其实是无所谓的
- 组合条件的过滤因子，相乘计算出；列与列之间不应该有太强的相关性，如城市和邮编
- 需要考虑极端情况下查询语句的性能

### 匹配列与过滤列
- 匹配列：对应到索引（等值查询）
- 过滤列：查出来后再过滤（复合索引中的范围查询）
- - 过滤列不能减少索引片的大小，但是能减少从表中随机读取数据的次数

## 索引的设计
- 总体来看减少随机读取的次数

### 三星索引
- 可能的最好索引
- 只需要进行一次**磁盘的随机读**及一个**窄索引片的顺序扫描**就可以得到全部的结果集
- 只要同时拥有**范围谓词**和 **ORDER BY** 时就不能满足三星，这时就需要**权衡利弊**了

#### 做法
1. 取出所有等值谓词中的列，作为索引开头的最开始的列。**减少索引片**的大小以减少需要扫描的数据行
2. 需要将 ORDER BY 列加入索引中。**避免排序**，减少磁盘 IO 和内存的使用
3. 需要将查询语句剩余的列全部加入到索引中。避免每一个对应的行都需要进行一次**随机 IO**
