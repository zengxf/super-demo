## 测试
- 参考：[热点流控-测试](热点流控.md#测试)

- 新建 `ClusterDemoApplication2`
```java
public class ClusterDemoApplication2 {
    public static void main(String[] args) {
        System.setProperty("csp.sentinel.dashboard.server", "127.0.0.1:8080");
        System.setProperty("project.name", "My-Cluster-8866");
        System.setProperty("server.port", "10012");
        SpringApplication.run(ClusterDemoApplication.class, args);
    }
}
```

- 启动 2 应用后
  - 访问：http://localhost:10010/hello/test1
  - 访问：http://localhost:10012/hello/test1

- 在控制台设置
  - 点击 **集群流控**：http://127.0.0.1:8080/#/dashboard/cluster/server/My-Cluster-8866
  - 点击 **+ 新增 Token Server**：
    - **机器类型** 使用默认：`应用内机器`
    - **选择机器** 选第一个即可
    - **Server 端口** 使用默认：`18730`
    - **最大允许 QPS** 设置为：`2`
    - **请从中选取 client：**
      - 选第一个，再点击 **→**
  - 点击 **保存**
    ```json
    // POST http://127.0.0.1:8080//cluster/assign/single_server/My-Cluster-8866
    {
        "clusterMap": {
            "machineId": "10.32.51.130@8720",
            "ip": "10.32.51.130",
            "port": 18730,
            "clientSet": [
                "10.32.51.130@8721"
            ],
            "belongToApp": true,
            "maxAllowedQps": 2
        },
        "remainingList": []
    }
    ```
  - 点击 **簇点链路**：http://127.0.0.1:8080/#/dashboard/identity/My-Cluster-8866
    - 在 `sayHello` 列，点击 **+ 流控**：
      - **是否集群** 打勾
      - **集群阈值模式** 选 `总体阈值`
      - **集群阈值** 设置为：`2`
      - **其他使用默认值**
    - 点击 **新增**
      ```json
      // POST http://127.0.0.1:8080//v1/flow/rule
      {
        "enable": false,
        "strategy": 0,
        "grade": 1,
        "controlBehavior": 0,
        "resource": "sayHello",
        "limitApp": "default",
        "clusterMode": true,
        "clusterConfig": {
            "thresholdType": "1"
        },
        "app": "My-Cluster-8866",
        "ip": "10.32.51.130",
        "port": "8720",
        "count": 2
      }
      ```

- 再测试
  - 连续刷 3 次：http://localhost:10010/hello/test1
  - 出现：`Oops, [test1] blocked by Sentinel`


## 原理
### 改模式
- Path: `/cluster/assign/single_server/{app}`

- `com.alibaba.csp.sentinel.dashboard.controller.cluster.ClusterAssignController`
```java
@RestController
@RequestMapping("/cluster/assign")
public class ClusterAssignController {

    // 全路径为: /cluster/assign/single_server/{app}
    @PostMapping("/single_server/{app}")
    public Result<ClusterAppAssignResultVO> apiAssignSingleClusterServersOfApp(
        @PathVariable String app,
        @RequestBody ClusterAppSingleServerAssignRequest assignRequest
    ) {
        ... // 参数校验
        try {
            return Result.ofSuccess(
                clusterAssignService.applyAssignToApp(  // ref: sign_m_100
                    app, Collections.singletonList(assignRequest.getClusterMap()),
                    assignRequest.getRemainingList()
                )
            );
        } ... // catch
    }
}
```

- `com.alibaba.csp.sentinel.dashboard.service.ClusterAssignServiceImpl`
```java
@Service
public class ClusterAssignServiceImpl implements ClusterAssignService {

    // sign_m_100
    @Override
    public ClusterAppAssignResultVO applyAssignToApp(String app, List<ClusterAppAssignMap> clusterMap,
                                                     Set<String> remainingSet) 
    {
        ... // 参数校验

        // Assign server and apply config.
        clusterMap.stream()
            .filter(Objects::nonNull)
            .filter(ClusterAppAssignMap::getBelongToApp)
            .map(e -> {
                String ip = e.getIp();
                int commandPort = parsePort(e);
                CompletableFuture<Void> f = modifyMode(ip, commandPort, ClusterStateManager.CLUSTER_SERVER)
                    .thenCompose(v -> applyServerConfigChange(app, ip, commandPort, e));
                return Tuple2.of(e.getMachineId(), f);
            })
            .forEach(t -> handleFutureSync(t, failedServerSet));

        // Assign client of servers and apply config.
        clusterMap.parallelStream()
            .filter(Objects::nonNull)
            .forEach(e -> applyAllClientConfigChange(app, e, failedClientSet));

        // Unbind remaining (unassigned) machines.
        applyAllRemainingMachineSet(app, remainingSet, failedClientSet);

        return new ClusterAppAssignResultVO() ... // 组装失败的 Client/Server 集合并返回
    }
}
```


### 流控原理
- 参考：
  - [链路控制-ClusterBuilderSlot](链路控制.md#ClusterBuilderSlot)
  - [链路控制-FlowSlot](链路控制.md#FlowSlot)