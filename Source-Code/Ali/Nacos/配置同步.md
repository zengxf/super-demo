## 客户端
### 使用示例
- https://github.com/zengxf/spring-demo/tree/master/cloud-demo/ali-nacos/cfg-test-1

### 启动流程
- 模块 `spring-cloud-starter-alibaba-nacos-config`
  - 会自动引入配置类 `NacosConfigAutoConfiguration`

- `com.alibaba.cloud.nacos.NacosConfigAutoConfiguration`
```java
/** Nacos 自动配置类 */
@Configuration(proxyBeanMethods = false)
@ConditionalOnProperty(name = "spring.cloud.nacos.config.enabled", matchIfMissing = true)
public class NacosConfigAutoConfiguration {

    // 返回配置管理器，ref: sign_c_110
    @Bean
    public NacosConfigManager nacosConfigManager(NacosConfigProperties nacosConfigProperties) {
        return new NacosConfigManager(nacosConfigProperties);   // sign_cm_110
    }

    // 返回刷新器，ref: sign_c_150
    @Bean
    public NacosContextRefresher nacosContextRefresher(
        NacosConfigManager nacosConfigManager, NacosRefreshHistory nacosRefreshHistory
    ) {
        return new NacosContextRefresher(nacosConfigManager, nacosRefreshHistory);
    }

}
```

- `com.alibaba.cloud.nacos.NacosConfigManager`
```java
// sign_c_110 配置管理器
public class NacosConfigManager {
    private static ConfigService service = null;

    // sign_cm_110 在构造器里初始化配置服务
    public NacosConfigManager(NacosConfigProperties nacosConfigProperties) {
        this.nacosConfigProperties = nacosConfigProperties;
        createConfigService(nacosConfigProperties); // sign_m_111
    }

    // sign_m_111
    static ConfigService createConfigService(NacosConfigProperties nacosConfigProperties) {
        if (Objects.isNull(service)) {
            synchronized (NacosConfigManager.class) {
                try {
                    if (Objects.isNull(service)) {
                        // 创建 NacosConfigService 实例类，ref: sign_c_120
                        service = NacosFactory.createConfigService(nacosConfigProperties.assembleConfigServiceProperties());
                    }
                } ... // catch 
            }
        }
        return service;
    }
}
```

- `com.alibaba.nacos.client.config.NacosConfigService`
```java
// sign_c_120 配置服务
public class NacosConfigService implements ConfigService {

    public NacosConfigService(Properties properties) throws NacosException {
        ... 
        ServerListManager serverListManager = new ServerListManager(clientProperties);
        serverListManager.start();  // 每 30 秒获取一次服务列表，ref: #GetServerListTask
        
        // 创建工作者，ref: sign_cm_130
        this.worker = new ClientWorker(this.configFilterChainManager, serverListManager, clientProperties);
        ...
    }

}
```

- `com.alibaba.nacos.client.config.impl.ClientWorker`
```java
// sign_c_130 客户端工作者
public class ClientWorker implements Closeable {

    // sign_cm_130
    public ClientWorker(final ConfigFilterChainManager configFilterChainManager, ServerListManager serverListManager,
            final NacosClientProperties properties) throws NacosException 
    {
        ...

        agent = new ConfigRpcTransportClient(properties, serverListManager);    // ref: sign_ic_131
        ScheduledExecutorService executorService = ... // 初始化调度线程池
        agent.setExecutor(executorService); // 设置调度线程池
        agent.start();  // 启动... ref: sign_m_141
    }

    // sign_ic_131 内部类
    public class ConfigRpcTransportClient extends ConfigTransportClient {   // 继承 sign_c_140
        // sign_c_132
        @Override
        public void startInternal() {
            executor.schedule(() -> {
                while (!executor.isShutdown() && !executor.isTerminated()) {
                    try {
                        listenExecutebell.poll(5L, TimeUnit.SECONDS);       // 相当于 5 秒一次
                        if (executor.isShutdown() || executor.isTerminated()) {
                            continue;
                        }
                        executeConfigListen();  // 执行配置监听逻辑
                    } ... // catch
                }
            }, 0L, TimeUnit.MILLISECONDS);
        }
    }
}
```

- `com.alibaba.nacos.client.config.impl.ConfigTransportClient`
```java
// sign_c_140
public abstract class ConfigTransportClient {

    // sign_m_141 启动
    public void start() throws NacosException {
        securityProxy.login(this.properties);
        this.executor.scheduleWithFixedDelay(
            () -> securityProxy.login(properties), 
            0, this.securityInfoRefreshIntervalMills, TimeUnit.MILLISECONDS
        );  // 相当于 5 秒一此心跳
        startInternal();    // sign_c_132
    }
}
```

- `com.alibaba.cloud.nacos.refresh.NacosContextRefresher`
```java
// sign_c_150 刷新器
public class NacosContextRefresher implements ApplicationListener<ApplicationReadyEvent>, ApplicationContextAware {

    @Override // sign_m_151 相当于 Spring 钩子
    public void onApplicationEvent(ApplicationReadyEvent event) {
        if (this.ready.compareAndSet(false, true)) {
            this.registerNacosListenersForApplications();   // sign_m_152
        }
    }

    // sign_m_152 注册监听所有相关的 key
    private void registerNacosListenersForApplications() {
        if (isRefreshEnabled()) {
            for (NacosPropertySource propertySource : NacosPropertySourceRepository.getAll()) {
                if (!propertySource.isRefreshable()) {
                    continue;
                }
                String dataId = propertySource.getDataId();
                registerNacosListener(propertySource.getGroup(), dataId);   // 注册监听单个 key, ref: sign_m_153
            }
        }
    }

    // sign_m_153 注册监听单个 key
    private void registerNacosListener(final String groupKey, final String dataKey) {
        String key = NacosPropertySourceRepository.getMapKey(dataKey, groupKey);

        // 创建监听器
        Listener listener = listenerMap.computeIfAbsent(key,
                lst -> new AbstractSharedListener() {
                    // 监听处理逻辑
                    @Override
                    public void innerReceive(String dataId, String group, String configInfo) {
                        refreshCountIncrement();
                        nacosRefreshHistory.addRefreshRecord(dataId, group, configInfo);
                        
                        // 通过 Sping 发送事件，监听器为 RefreshEventListener (其会刷新上下文)
                        applicationContext.publishEvent(new RefreshEvent(this, null, "Refresh Nacos config"));
                        ... // log
                    }
                });

        try {
            configService.addListener(dataKey, groupKey, listener); // 注册监听器
            ... // log
        } ... // catch
    }
}
```