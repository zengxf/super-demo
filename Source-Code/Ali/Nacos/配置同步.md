## 客户端
### 使用示例
- https://github.com/zengxf/spring-demo/tree/master/cloud-demo/ali-nacos/cfg-test-1

### Spring-Clound 部分
#### 启动流程
- 模块 `spring-cloud-starter-alibaba-nacos-config`
  - 会自动引入配置类 `NacosConfigAutoConfiguration`

- `com.alibaba.cloud.nacos.NacosConfigAutoConfiguration`
```java
/** Nacos 自动配置类 */
@Configuration(proxyBeanMethods = false)
@ConditionalOnProperty(name = "spring.cloud.nacos.config.enabled", matchIfMissing = true)
public class NacosConfigAutoConfiguration {

    // 返回配置管理器，ref: sign_c_110
    @Bean
    public NacosConfigManager nacosConfigManager(NacosConfigProperties nacosConfigProperties) {
        return new NacosConfigManager(nacosConfigProperties);   // ref: sign_cm_110
    }

    // 返回刷新器，ref: sign_c_150
    @Bean
    public NacosContextRefresher nacosContextRefresher(
        NacosConfigManager nacosConfigManager, NacosRefreshHistory nacosRefreshHistory
    ) {
        return new NacosContextRefresher(nacosConfigManager, nacosRefreshHistory);  // ref: sign_cm_150
    }

}
```

#### 配置管理器
- 获取 `configService`

- `com.alibaba.cloud.nacos.NacosConfigManager`
```java
// sign_c_110 配置管理器
public class NacosConfigManager {
    private static ConfigService service = null;

    // sign_cm_110 在构造器里初始化配置服务
    public NacosConfigManager(NacosConfigProperties nacosConfigProperties) {
        this.nacosConfigProperties = nacosConfigProperties;
        createConfigService(nacosConfigProperties); // ref: sign_m_111
    }

    // sign_m_111 创建 ConfigService 实例
    static ConfigService createConfigService(NacosConfigProperties nacosConfigProperties) {
        if (Objects.isNull(service)) {
            synchronized (NacosConfigManager.class) {
                try {
                    if (Objects.isNull(service)) {
                        // 创建 NacosConfigService 实例类，ref: sign_c_120
                        service = NacosFactory.createConfigService(nacosConfigProperties.assembleConfigServiceProperties());
                    }
                } ... // catch 
            }
        }
        return service;
    }

    // sign_m_112 获取 ConfigService 实例
	public ConfigService getConfigService() {
		if (Objects.isNull(service)) {
			createConfigService(this.nacosConfigProperties);    // ref: sign_m_111
		}
		return service;
	}
}
```

#### 刷新器
- 创建监听器，添加到 `configService` 里
  - **监听配置更改，刷新 Spring 应用配置**

- `com.alibaba.cloud.nacos.refresh.NacosContextRefresher`
```java
// sign_c_150 刷新器
public class NacosContextRefresher implements ApplicationListener<ApplicationReadyEvent>, ApplicationContextAware {

    // sign_cm_150 构造器
	public NacosContextRefresher(NacosConfigManager nacosConfigManager,
			NacosRefreshHistory refreshHistory) 
    {
        ...
		this.configService = nacosConfigManager.getConfigService(); // 获取 configService, ref: sign_m_112
	}

    @Override // sign_m_151 相当于 Spring 钩子
    public void onApplicationEvent(ApplicationReadyEvent event) {
        if (this.ready.compareAndSet(false, true)) {
            this.registerNacosListenersForApplications();   // ref: sign_m_152
        }
    }

    // sign_m_152 注册监听所有相关的 key
    private void registerNacosListenersForApplications() {
        if (isRefreshEnabled()) {
            for (NacosPropertySource propertySource : NacosPropertySourceRepository.getAll()) {
                if (!propertySource.isRefreshable()) {
                    continue;
                }
                String dataId = propertySource.getDataId();
                registerNacosListener(propertySource.getGroup(), dataId);   // 注册监听单个 key, ref: sign_m_153
            }
        }
    }

    // sign_m_153 注册监听单个 key
    private void registerNacosListener(final String groupKey, final String dataKey) {
        String key = NacosPropertySourceRepository.getMapKey(dataKey, groupKey);

        // 创建监听器
        Listener listener = listenerMap.computeIfAbsent(key,
                lst -> new AbstractSharedListener() {
                    // 监听处理逻辑
                    @Override
                    public void innerReceive(String dataId, String group, String configInfo) {
                        refreshCountIncrement();
                        nacosRefreshHistory.addRefreshRecord(dataId, group, configInfo);
                        
                        // 通过 Sping 发送事件，监听器为 RefreshEventListener (其会刷新上下文)
                        applicationContext.publishEvent(new RefreshEvent(this, null, "Refresh Nacos config"));
                        ... // log
                    }
                });

        try {
            configService.addListener(dataKey, groupKey, listener); // 注册监听器
            ... // log
        } ... // catch
    }
}
```

### Nacos 部分
#### 配置服务
- 获取 `ClientWorker` 和服务列表

- `com.alibaba.nacos.client.config.NacosConfigService`
```java
// sign_c_120 配置服务
public class NacosConfigService implements ConfigService {

    public NacosConfigService(Properties properties) throws NacosException {
        ... 
        ServerListManager serverListManager = new ServerListManager(clientProperties);
        serverListManager.start();  // 每 30 秒获取一次服务列表，ref: #GetServerListTask
        
        // 创建工作者，ref: sign_cm_130
        this.worker = new ClientWorker(this.configFilterChainManager, serverListManager, clientProperties);
        ...
    }

}
```

#### 客户端工作者
- 与服务中心交互，并维持心跳

- `com.alibaba.nacos.client.config.impl.ClientWorker`
```java
// sign_c_130 客户端工作者
public class ClientWorker implements Closeable {

    // sign_cm_130
    public ClientWorker(final ConfigFilterChainManager configFilterChainManager, ServerListManager serverListManager,
            final NacosClientProperties properties) throws NacosException 
    {
        ...
        agent = new ConfigRpcTransportClient(properties, serverListManager);    // ref: sign_ic_131
        ScheduledExecutorService executorService = ... // 初始化调度线程池
        agent.setExecutor(executorService); // 设置调度线程池
        agent.start();  // 启动(心跳)，ref: sign_m_141
    }

    // sign_ic_131 内部类
    public class ConfigRpcTransportClient extends ConfigTransportClient {   // 继承 sign_c_140
        // sign_c_132
        @Override
        public void startInternal() {
            executor.schedule(() -> {
                while (!executor.isShutdown() && !executor.isTerminated()) {
                    try {
                        listenExecutebell.poll(5L, TimeUnit.SECONDS);       // 相当于 5 秒一次
                        if (executor.isShutdown() || executor.isTerminated()) {
                            continue;
                        }
                        executeConfigListen();  // 执行配置监听逻辑
                    } ... // catch
                }
            }, 0L, TimeUnit.MILLISECONDS);
        }
    }
}
```

- `com.alibaba.nacos.client.config.impl.ConfigTransportClient`
```java
// sign_c_140
public abstract class ConfigTransportClient {

    // sign_m_141 启动(心跳)
    public void start() throws NacosException {
        securityProxy.login(this.properties);
        this.executor.scheduleWithFixedDelay(
            () -> securityProxy.login(properties), 
            0, this.securityInfoRefreshIntervalMills, TimeUnit.MILLISECONDS
        );  // 相当于 5 秒一此心跳
        startInternal();    // sign_c_132
    }
}
```


## 服务端
- 修改配置时，会发送配置更改事件，在监听处理时，再进行 gRPC 通知客户端同步
  - 配置更改事件参考：[事件通知-事件监听 sign_c_600 | sign_m_610](事件通知.md#事件监听)

- `com.alibaba.nacos.config.server.service.notify.AsyncNotifyService`
```java
    /** 在构造器初始化订阅者 */
    public AsyncNotifyService(ServerMemberManager memberManager) {
        ...

        NotifyCenter.registerSubscriber(new Subscriber() {  // 匿名订阅者
            @Override
            public void onEvent(Event event) {
                if (event instanceof ConfigDataChangeEvent) {
                    ConfigDataChangeEvent evt = (ConfigDataChangeEvent) event;
                    ...
                    
                    Collection<Member> ipList = memberManager.allMembers();
                    Queue<NotifySingleRpcTask> rpcQueue = new LinkedList<>();
                    
                    for (Member member : ipList) {
                        // 使用 gRPC 通知
                        rpcQueue.add(new NotifySingleRpcTask(...)); // NotifySingleRpcTask 只是对数据进行封装
                    }
                    if (!rpcQueue.isEmpty()) {
                        ConfigExecutor.executeAsyncNotify(new AsyncRpcTask(rpcQueue));  // ref: sign_c_210
                    }
                }
            }

            ...
        });
    }

    // sign_c_210
    class AsyncRpcTask implements Runnable {
        
        private Queue<NotifySingleRpcTask> queue;

        ... // 构造器赋值 queue
        
        @Override
        public void run() {
            while (!queue.isEmpty()) {
                NotifySingleRpcTask task = queue.poll();
                
                ConfigChangeClusterSyncRequest syncRequest = new ConfigChangeClusterSyncRequest();
                ... // 设置 syncRequest 属性值
                Member member = task.member;
                if (memberManager.getSelf().equals(member)) {       // 只是客户端连接
                    ... // 省略 Beta 处理

                        // ref: sign_m_220
                        dumpService.dump(syncRequest.getDataId(), syncRequest.getGroup(), syncRequest.getTenant(),
                                syncRequest.getTag(), syncRequest.getLastModified(), NetUtils.localIP());
                    
                    continue;
                }
                
                if (memberManager.hasMember(member.getAddress())) { // 集群通知
                    boolean unHealthNeedDelay = memberManager.isUnHealth(member.getAddress());
                    if (unHealthNeedDelay) {
                        ... // 不健康，则延迟处理
                    } else {
                        // gRPC 通知
                        try {
                            configClusterRpcClientProxy
                                    .syncConfigChange(member, syncRequest, new AsyncRpcNotifyCallBack(task));
                        } ... // catch
                    }
                }

                ...
            }
        }
    }
```

- `com.alibaba.nacos.config.server.service.dump.DumpService`
```java
public abstract class DumpService { // 使用 MySQL 时，是 ExternalDumpService 实例

    // sign_m_220
    public void dump(String dataId, String group, String tenant, String tag, long lastModified, String handleIp) {
        dump(dataId, group, tenant, tag, lastModified, handleIp, false);    // ref: sign_m_221
    }
    
    // sign_m_221
    public void dump(String dataId, String group, String tenant, String tag, long lastModified, String handleIp,
            boolean isBeta) {
        String groupKey = GroupKey2.getKey(dataId, group, tenant);
        String taskKey = String.join("+", dataId, group, tenant, String.valueOf(isBeta), tag);
        /**
         * DumpTask: 有旧的数据时，会覆盖旧的，相当于只用最新的数据进行通知。
         * 添加到任务管理器，ref: sign_m_230
         */
        dumpTaskMgr.addTask(taskKey, new DumpTask(groupKey, tag, lastModified, handleIp, isBeta));
    }

}
```

### 任务管理器
- `com.alibaba.nacos.config.server.manager.TaskManager`
```java
/** 任务管理器。每 100 毫秒执行一次 ref: sign_cm_241 */
public final class TaskManager extends NacosDelayTaskExecuteEngine implements TaskManagerMBean {
    // sign_m_230 添加任务
    @Override
    public void addTask(Object key, AbstractDelayTask newTask) {
        super.addTask(key, newTask);    // ref: sign_m_240
        ... // 指标设置
    }

    // sign_m_231
    @Override
    protected void processTasks() {
        super.processTasks();           // ref: sign_m_241
        ... // 指标设置
        ... // 通知其他线程
    }
}
```

- `com.alibaba.nacos.common.task.engine.NacosDelayTaskExecuteEngine`
```java
public class NacosDelayTaskExecuteEngine extends AbstractNacosTaskExecuteEngine<AbstractDelayTask> {

    public NacosDelayTaskExecuteEngine(String name) {
        this(name, null);
    }
    
    public NacosDelayTaskExecuteEngine(String name, Logger logger) {
        this(name, 32, logger, 100L);   // ref: sign_cm_241
    }

    // sign_cm_241
    public NacosDelayTaskExecuteEngine(String name, int initCapacity, Logger logger, long processInterval) {
        super(logger);
        tasks = new ConcurrentHashMap<>(initCapacity);  // def: 32
        processingExecutor = ExecutorFactory.newSingleScheduledExecutorService(new NameThreadFactory(name));
        // processInterval -> def: 100L
        /**
         * 默认：每 100 毫秒执行一次 ProcessRunnable
         * ref: sign_c_241
         */
        processingExecutor
                .scheduleWithFixedDelay(new ProcessRunnable(), processInterval, processInterval, TimeUnit.MILLISECONDS);
    }

    /** sign_c_241 */
    private class ProcessRunnable implements Runnable {
        @Override
        public void run() {
            try {
                processTasks(); // ref: sign_m_241
            } ... catch
        }
    }

    // sign_m_240
    @Override
    public void addTask(Object key, AbstractDelayTask newTask) {
        lock.lock();
        try {
            AbstractDelayTask existTask = tasks.get(key);
            if (null != existTask) {
                newTask.merge(existTask);   // DumpTask 的 merge() 实现为空，相当于只用新的
            }
            tasks.put(key, newTask);        // 添加任务
        } finally {
            lock.unlock();
        }
    }

    // sign_m_241 (每 100 毫秒执行一次，执行线程参考: sign_c_241)
    protected void processTasks() {
        Collection<Object> keys = getAllTaskKeys();
        for (Object taskKey : keys) {
            AbstractDelayTask task = removeTask(taskKey);
            ... // task 为 null 跳过

            /**
             * DumpTask 对应的执行器为: DumpProcessor
             * ref: sign_c_250
             */
            NacosTaskProcessor processor = getProcessor(taskKey);
            ... // processor 为 null 跳过

            try {
                // 如果处理失败，则重新添加任务。处理任务 ref: sign_m_250
                if (!processor.process(task)) {
                    retryFailedTask(taskKey, task);
                }
            } ... // catch
        }
    }
}
```

### 任务处理器
- `com.alibaba.nacos.config.server.service.dump.processor.DumpProcessor`
```java
/** sign_c_250 Dump 处理器 */
public class DumpProcessor implements NacosTaskProcessor {

    // sign_m_250 处理任务
    @Override
    public boolean process(NacosTask task) {
        DumpTask dumpTask = (DumpTask) task;
        ... // 取 dumpTask 属性值
        
        ConfigDumpEvent.ConfigDumpEventBuilder build = ConfigDumpEvent.builder().namespaceId(tenant).dataId(dataId)
                .group(group).isBeta(isBeta).tag(tag).lastModifiedTs(lastModified).handleIp(handleIp);
        
        ... // 省略 Beta 处理
        if (StringUtils.isBlank(tag)) {
            ConfigInfo cf = configInfoPersistService.findConfigInfo(dataId, group, tenant);
            
            build.remove(Objects.isNull(cf));
            build.content(Objects.isNull(cf) ? null : cf.getContent());
            build.type(Objects.isNull(cf) ? null : cf.getType());
            build.encryptedDataKey(Objects.isNull(cf) ? null : cf.getEncryptedDataKey());
        } ... // else (tag 不为空的处理)

        return DumpConfigHandler.configDump(build.build()); // ref: sign_m_260
    }
}
```

- `com.alibaba.nacos.config.server.service.dump.DumpConfigHandler`
```java
    // sign_m_260
    public static boolean configDump(ConfigDumpEvent event) {
        ... // 读取 event 属性
        ... // Beta 处理

        if (StringUtils.isBlank(event.getTag())) {
            ... // 系统配置更改处理
            
            boolean result;
            if (!event.isRemove()) {
                result = ConfigCacheService // ref: sign_m_270
                        .dump(dataId, group, namespaceId, content, lastModified, type, encryptedDataKey);
                
                ... // log 打印
            } ... // else (不是删除事件)

            return result;
        } ... // else (tag 不为空)        
    }
```

- `com.alibaba.nacos.config.server.service.ConfigCacheService`
```java
public class ConfigCacheService {
    
    // sign_m_270
    public static boolean dump(String dataId, String group, String tenant, String content, long lastModifiedTs,
            String type, String encryptedDataKey) 
    {
        String groupKey = GroupKey2.getKey(dataId, group, tenant);
        CacheItem ci = makeSure(groupKey, encryptedDataKey, false);
        ci.setType(type);
        final int lockResult = tryWriteLock(groupKey);
        
        ... // 获取写锁失败，返回
        
        try {
            final String md5 = MD5Utils.md5Hex(content, Constants.ENCODE);
            ... // 更改时间戳判断处理
            ... // 保存到文件处理

            updateMd5(groupKey, md5, lastModifiedTs, encryptedDataKey); // ref: sign_m_271
            return true;
        } ...   // catch
        ...     // finally (释放 groupKey 锁)
    }

    // sign_m_271
    public static void updateMd5(String groupKey, String md5, long lastModifiedTs, String encryptedDataKey) {
        CacheItem cache = makeSure(groupKey, encryptedDataKey, false);  // ref: sign_m_272
        if (cache.md5 == null || !cache.md5.equals(md5)) {
            cache.md5 = md5;
            cache.lastModifiedTs = lastModifiedTs;
            /**
             * 发布事件 (订阅者为 RpcConfigChangeNotifier)
             * 处理参考: sign_m_280
             */
            NotifyCenter.publishEvent(new LocalDataChangeEvent(groupKey));
        }
    }

    // sign_m_272 获取或创建 item
    static CacheItem makeSure(final String groupKey, String encryptedDataKey, boolean isBeta) {
        CacheItem item = CACHE.get(groupKey);

        ... // item 不为空，返回

        CacheItem tmp = new CacheItem(groupKey);    // 创建并添加到 Map，并返回
        setEncryptDateKey(tmp, encryptedDataKey, isBeta);
        item = CACHE.putIfAbsent(groupKey, tmp);
        return (null == item) ? tmp : item;
    }

}
```

### gRPC-通知器
- `com.alibaba.nacos.config.server.remote.RpcConfigChangeNotifier`
```java
/** sign_c_280 */
@Component(value = "rpcConfigChangeNotifier")
public class RpcConfigChangeNotifier extends Subscriber<LocalDataChangeEvent> {

    // sign_m_280
    @Override
    public void onEvent(LocalDataChangeEvent event) {
        ... // 读取 event 属性
        configDataChanged(groupKey, dataId, group, tenant, isBeta, betaIps, tag);   // ref: sign_m_281
    }

    // sign_m_281
    public void configDataChanged(String groupKey, String dataId, String group, String tenant, boolean isBeta,
            List<String> betaIps, String tag) 
    {
        
        Set<String> listeners = configChangeListenContext.getListeners(groupKey);
        ... // listeners 为空返回
        
        int notifyClientCount = 0;
        for (final String client : listeners) {
            Connection connection = connectionManager.getConnection(client);
            ... // connection 为空，则跳过
            
            ConnectionMeta metaInfo = connection.getMetaInfo();
            
            ... // beta ips check.
            ... // tag check
            
            ConfigChangeNotifyRequest notifyRequest = ConfigChangeNotifyRequest.build(dataId, group, tenant);
            
            // ref: sign_c_281 (处理逻辑，ref: sign_m_284)
            RpcPushTask rpcPushRetryTask = new RpcPushTask(notifyRequest, 50, client, clientIp, metaInfo.getAppName());
            push(rpcPushRetryTask); // ref: sign_m_282
        }
    }

    // sign_m_282
    private void push(RpcPushTask retryTask) {
        ConfigChangeNotifyRequest notifyRequest = retryTask.notifyRequest;
        if (retryTask.isOverTimes()) {  // ref: sign_m_283
            ... // 任务尝试次数超标处理
        } else if (connectionManager.getConnection(retryTask.connectionId) != null) {
            // 将任务添加到延迟队列
            // first time: delay 0s; second time: delay 2s; third time: delay 4s
            ConfigExecutor.getClientConfigNotifierServiceExecutor()
                    .schedule(retryTask, retryTask.tryTimes * 2, TimeUnit.SECONDS);
        } else {
            // client is already offline, ignore task.
        }
    }

    // sign_c_281
    class RpcPushTask implements Runnable {
        
        ConfigChangeNotifyRequest notifyRequest;
        int maxRetryTimes = -1; // def: 50
        int tryTimes = 0;
        
        // sign_m_283
        public boolean isOverTimes() {
            return maxRetryTimes > 0 && this.tryTimes >= maxRetryTimes;
        }
        
        // sign_m_284
        @Override
        public void run() {
            tryTimes++;
            TpsCheckRequest tpsCheckRequest = new TpsCheckRequest();
           
            tpsCheckRequest.setPointName(POINT_CONFIG_PUSH);
            if (!tpsControlManager.check(tpsCheckRequest).isSuccess()) {    // TPS 校验通过
                push(this);
            } else {
                // 使用 gRPC 通知
                // 处理逻辑在 com.alibaba.nacos.core.remote.grpc.GrpcConnection #asyncRequest
                rpcPushService.pushWithCallback(connectionId, notifyRequest, 
                        new AbstractPushCallBack(3000L) {
                            @Override
                            public void onSuccess() {
                                ... // TPS 记录 POINT_CONFIG_PUSH_SUCCESS
                            }
                            
                            @Override
                            public void onFail(Throwable e) {
                                ... // TPS 记录 POINT_CONFIG_PUSH_FAIL
                                push(RpcPushTask.this); // 失败，再 push 重试一次
                            }
                        }, 
                        ConfigExecutor.getClientConfigNotifierServiceExecutor());
            }
        }
    }
    
}
```

### 总结
- 流程大致为：`ConfigDataChangeEvent -> DumpTask -> LocalDataChangeEvent`