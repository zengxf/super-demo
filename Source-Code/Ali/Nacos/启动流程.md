## 入口参考
- [控制台启动](控制台启动.md)


## 配置初始化
- `nacos-console` 依赖中包含 `config [nacos-config]` 模块
  - `nacos-config` 模块中定义的 `spring.factories` 文件
    - 指定 Spring-SPI 的 `ApplicationContextInitializer` 为 `PropertyUtil`

- `com.alibaba.nacos.config.server.utils.PropertyUtil`
```java
/** 配置属性工具类 */
public class PropertyUtil implements ApplicationContextInitializer<ConfigurableApplicationContext> {

    @Override   // 重写初始化方法
    public void initialize(ConfigurableApplicationContext configurableApplicationContext) {
        loadSetting();  // sign_m_011
    }

    // sign_m_011
    private void loadSetting() {
        try {
            setNotifyConnectTimeout(...);
            setNotifySocketTimeout(...));
            setHealthCheck(...);
            setMaxHealthCheckFailCount(...);
            setMaxContent(...);
            // 容量管理
            setManageCapacity(getBoolean(PropertiesConstant.IS_MANAGE_CAPACITY, isManageCapacity));
            setCapacityLimitCheck(getBoolean(PropertiesConstant.IS_CAPACITY_LIMIT_CHECK, isCapacityLimitCheck));
            setDefaultClusterQuota(getInt(PropertiesConstant.DEFAULT_CLUSTER_QUOTA, defaultClusterQuota));
            setDefaultGroupQuota(getInt(PropertiesConstant.DEFAULT_GROUP_QUOTA, defaultGroupQuota));
            setDefaultTenantQuota(getInt(PropertiesConstant.DEFAULT_TENANT_QUOTA, defaultTenantQuota));
            setDefaultMaxSize(getInt(PropertiesConstant.DEFAULT_MAX_SIZE, defaultMaxSize));
            setDefaultMaxAggrCount(getInt(PropertiesConstant.DEFAULT_MAX_AGGR_COUNT, defaultMaxAggrCount));
            setDefaultMaxAggrSize(getInt(PropertiesConstant.DEFAULT_MAX_AGGR_SIZE, defaultMaxAggrSize));
            setCorrectUsageDelay(getInt(PropertiesConstant.CORRECT_USAGE_DELAY, correctUsageDelay));
            setInitialExpansionPercent(getInt(PropertiesConstant.INITIAL_EXPANSION_PERCENT, initialExpansionPercent));
    
            // 存储设置
            String platform = DatasourcePlatformUtil.getDatasourcePlatform(""); // DB 平台    ref: sign_m_020
            boolean useExternalStorage = !PropertiesConstant.EMPTY_DATASOURCE_PLATFORM.equalsIgnoreCase(platform)
                    && !PropertiesConstant.DERBY.equalsIgnoreCase(platform);    // DB 不为 derby (内存数据库) 则表示外部
            setUseExternalDB(useExternalStorage);

            if (isUseExternalDB()) {
                setEmbeddedStorage(false);
            } else {
                ... // 省略 embeddedStorage 和 useExternalDB 重新设置
            }
        } ... // catch
    }
}
```

- `com.alibaba.nacos.config.server.utils.DatasourcePlatformUtil`
```java
    // sign_m_020 获取 DB 平台
    public static String getDatasourcePlatform(String defaultPlatform) {
        // 首先从 spring.sql.init.platform 配置获取    ref: sign_m_030
        String platform = EnvUtil.getProperty(PropertiesConstant.DATASOURCE_PLATFORM_PROPERTY, defaultPlatform);
        if (StringUtils.isBlank(platform)) {
            // 再从 spring.datasource.platform 配置获取
            platform = EnvUtil.getProperty(PropertiesConstant.DATASOURCE_PLATFORM_PROPERTY_OLD, defaultPlatform);
        }
        return platform;
    }
```

- `com.alibaba.nacos.sys.env.EnvUtil`
  - 位于 `sys [nacos-sys]` 模块
```java
    // sign_m_030 获取环境变量
    public static String getProperty(String key, String defaultValue) {
        // environment 设置  ref: sign_m_031
        return environment.getProperty(key, defaultValue);
    }

    // sign_m_031 设置环境  (调用方参考: sign_m_111)
    public static void setEnvironment(ConfigurableEnvironment environment) {
        EnvUtil.environment = environment;
    }
```


## 环境初始化
- `nacos-console` 间接依赖 `core [nacos-core]` 模块
  - `nacos-core` 模块中定义的 `spring.factories` 文件
    - 指定 Spring-SPI 的 `SpringApplicationRunListener` 为 `nacos.SpringApplicationRunListener`

- `com.alibaba.nacos.core.code.SpringApplicationRunListener`
  - Java SPI 参考：[JDK-SPI](../../JDK/SPI.md)
```java
/** Spring 应用运行监听器 */
public class SpringApplicationRunListener implements org.springframework.boot.SpringApplicationRunListener, Ordered {

    // SPI 加载并实例化 NacosApplicationListener 实现类
    Collection<NacosApplicationListener> nacosApplicationListeners = NacosServiceLoader.load(NacosApplicationListener.class);

    @Override // 重写环境准备好的回调方法
    public void environmentPrepared(ConfigurableBootstrapContext bootstrapContext,
            ConfigurableEnvironment environment) 
    {
        for (NacosApplicationListener nacosApplicationListener : nacosApplicationListeners) {
            nacosApplicationListener.environmentPrepared(environment);  // sign_m_110
        }
    }

}
```

- `com.alibaba.nacos.core.listener.StartingApplicationListener`
```java
public class StartingApplicationListener implements NacosApplicationListener {

    // sign_m_110 环境准备好
    @Override
    public void environmentPrepared(ConfigurableEnvironment environment) {
        makeWorkDir();
        
        injectEnvironment(environment); // sign_m_111
        
        loadPreProperties(environment);
        
        initSystemProperty();
    }

    // sign_m_111 注入环境
    private void injectEnvironment(ConfigurableEnvironment environment) {
        EnvUtil.setEnvironment(environment);    // 设置环境  ref: sign_m_031
    }

}
```