## 参考
- Nacos 服务注册的原理： https://www.cnblogs.com/wuzhenzhao/p/13625491.html
- Nacos 注册中心原理详解： https://mdnice.com/writing/857134aae3044b80bb15181deb74abbe

### 原理图
![x](https://img2020.cnblogs.com/blog/1383365/202009/1383365-20200908194923223-29413080.png)


## 使用示例
- https://github.com/zengxf/spring-demo/tree/master/cloud-demo/ali-nacos/naming-test-1


## 关键类
- 接口定义
  - `com.alibaba.nacos.client.naming.remote.NamingClientProxy`
    - 方法是 `registerService(...)`
- 实现类
  - `com.alibaba.nacos.client.naming.remote.http.NamingHttpClientProxy`
  - `com.alibaba.nacos.client.naming.remote.gprc.NamingGrpcClientProxy`
    - 用的是此实例
  - `com.alibaba.nacos.client.naming.remote.NamingClientProxyDelegate`
    - 对上面两实例的封装


## 服务提供者
- 参考：[使用示例](#使用示例)
  - 启动 `test.Ser1App1`
- 进入源码，在 `com.alibaba.nacos.client.naming.remote.NamingClientProxyDelegate #registerService`
  - 方法体打断点
  - 启动时，进入断点后，输入表达式：`new RuntimeException("服务注册栈跟踪").printStackTrace();`
    - 输出调用栈

### 调用栈
```js
java.lang.RuntimeException: 服务注册栈跟踪
    at com.alibaba.nacos.client.naming.remote.NamingClientProxyDelegate.registerService(NamingClientProxyDelegate.java:98)    // ref: sign_m_110
    at com.alibaba.nacos.client.naming.NacosNamingService.registerInstance(NacosNamingService.java:143)
    at com.alibaba.cloud.nacos.registry.NacosServiceRegistry.register(NacosServiceRegistry.java:75)
    at org.springframework.cloud.client.serviceregistry.AbstractAutoServiceRegistration.register(AbstractAutoServiceRegistration.java:264)
    at com.alibaba.cloud.nacos.registry.NacosAutoServiceRegistration.register(NacosAutoServiceRegistration.java:78)
    at org.springframework.cloud.client.serviceregistry.AbstractAutoServiceRegistration.start(AbstractAutoServiceRegistration.java:156)
    at org.springframework.cloud.client.serviceregistry.AbstractAutoServiceRegistration.onApplicationEvent(AbstractAutoServiceRegistration.java:119)
    at org.springframework.cloud.client.serviceregistry.AbstractAutoServiceRegistration.onApplicationEvent(AbstractAutoServiceRegistration.java:49)
    at org.springframework.context.event.SimpleApplicationEventMulticaster.doInvokeListener(SimpleApplicationEventMulticaster.java:176)
    at org.springframework.context.event.SimpleApplicationEventMulticaster.invokeListener(SimpleApplicationEventMulticaster.java:169)
    at org.springframework.context.event.SimpleApplicationEventMulticaster.multicastEvent(SimpleApplicationEventMulticaster.java:143)
    at org.springframework.context.support.AbstractApplicationContext.publishEvent(AbstractApplicationContext.java:413)
    at org.springframework.context.support.AbstractApplicationContext.publishEvent(AbstractApplicationContext.java:370)
    at org.springframework.boot.web.servlet.context.WebServerStartStopLifecycle.start(WebServerStartStopLifecycle.java:47)
    at org.springframework.context.support.DefaultLifecycleProcessor.doStart(DefaultLifecycleProcessor.java:178)
    at org.springframework.context.support.DefaultLifecycleProcessor$LifecycleGroup.start(DefaultLifecycleProcessor.java:356)
    at java.base/java.lang.Iterable.forEach(Iterable.java:75)
    at org.springframework.context.support.DefaultLifecycleProcessor.startBeans(DefaultLifecycleProcessor.java:155)
    at org.springframework.context.support.DefaultLifecycleProcessor.onRefresh(DefaultLifecycleProcessor.java:123)
    at org.springframework.context.support.AbstractApplicationContext.finishRefresh(AbstractApplicationContext.java:932)
    at org.springframework.context.support.AbstractApplicationContext.refresh(AbstractApplicationContext.java:587)
    at org.springframework.boot.web.servlet.context.ServletWebServerApplicationContext.refresh(ServletWebServerApplicationContext.java:146)
    at org.springframework.boot.SpringApplication.refresh(SpringApplication.java:730)
    at org.springframework.boot.SpringApplication.refreshContext(SpringApplication.java:432)
    at org.springframework.boot.SpringApplication.run(SpringApplication.java:308)
    at test.Ser1App1.main(Ser1App1.java:14)
```

### 服务注册请求
- `com.alibaba.nacos.client.naming.remote.NamingClientProxyDelegate`
```java
public class NamingClientProxyDelegate implements NamingClientProxy {
    // sign_m_110 注册服务
    @Override
    public void registerService(String serviceName, String groupName, Instance instance) throws NacosException {
        // ref: sign_m_111, 返回 grpcClientProxy
        // 调用真正的客户端进行注册, ref: sign_m_120
        getExecuteClientProxy(instance).registerService(serviceName, groupName, instance);
    }

    // sign_m_111
    private NamingClientProxy getExecuteClientProxy(Instance instance) {
        // 默认 ephemeral 为 true，使用 gRPC 通信
        return instance.isEphemeral() ? grpcClientProxy : httpClientProxy;
    }
}
```

- `com.alibaba.nacos.client.naming.remote.gprc.NamingGrpcClientProxy`
  - 参考: [客户端同步-gRPC-通信 sign_m_171](客户端同步.md#gRPC-通信)
  - 参考: [同步-gRPC-gRPC-服务实现 sign_m_220](同步-gRPC.md#gRPC-服务实现)
```java
public class NamingGrpcClientProxy extends AbstractNamingClientProxy {
    // sign_m_120 使用 gRPC 通信进行注册服务
    @Override
    public void registerService(String serviceName, String groupName, Instance instance) throws NacosException {
        ... // log
        // 添加 redo 记录，在 RedoScheduledTask 定时任务里作 redo 处理
        redoService.cacheInstanceForRedo(serviceName, groupName, instance);
        doRegisterService(serviceName, groupName, instance);    // 执行注册操作, ref: sign_m_121
    }

    // sign_m_121 执行注册操作
    public void doRegisterService(String serviceName, String groupName, Instance instance) throws NacosException {
        // 创建请求。其处理器为 InstanceRequestHandler 实例
        // 参考: [同步-gRPC-gRPC-服务实现 sign_m_220]
        InstanceRequest request = new InstanceRequest(namespaceId, serviceName, groupName,
                NamingRemoteConstants.REGISTER_INSTANCE, instance);
        requestToServer(request, Response.class);               // 请求服务端, ref: sign_m_122
        redoService.instanceRegistered(serviceName, groupName); // 更改 redo 记录状态
    }

    // sign_m_122 请求服务端
    private <T extends Response> T requestToServer(AbstractNamingRequest request, Class<T> responseClass)
            throws NacosException 
    {
        try {
            request.putAllHeader(
                    getSecurityHeaders(request.getNamespace(), request.getGroupName(), request.getServiceName()));

            // rpcClient 为 GrpcSdkClient 实例
            // gRPC 请求参考：[客户端同步-gRPC-通信 sign_m_171]
            Response response =
                    requestTimeout < 0 ? rpcClient.request(request) : rpcClient.request(request, requestTimeout);

            ... // 响应不是成功的结果，抛出 NacosException 异常

            if (responseClass.isAssignableFrom(response.getClass())) {
                return (T) response;    // 是期望的响应类，才返回；否则抛出 NacosException 异常
            }
        } ... // catch: 封装成 NacosException 异常，并抛出
    }
    
}
```
