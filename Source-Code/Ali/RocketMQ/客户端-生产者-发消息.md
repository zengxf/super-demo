# RocketMQ-客户端-生产者-发消息


---
## 测试
- 参考：`rocketmq-example` 模块

- `org.apache.rocketmq.example.quickstart.Producer`
```java
public class Producer2 {    // 自己建的新类
    public static final String PRODUCER_GROUP = "please_rename_unique_group_name";
    public static final String NAME_SRV_ADDR = "127.0.0.1:9876";
    public static final String TOPIC = "TopicTest";
    public static final String TAG = "TagA";

    public static void main(String[] args) throws Exception {
        DefaultMQProducer producer = new DefaultMQProducer(PRODUCER_GROUP); // 创建生产者，ref: sign_cm_110
        producer.setNamesrvAddr(NAME_SRV_ADDR);
        producer.start();                                                   // 启动 (初始化) 生产者，ref: sign_m_110

        byte[] contentArr = ("Hello RocketMQ 1111").getBytes(); // def: UTF-8
        Message msg = new Message(TOPIC, TAG, contentArr);
        SendResult sendResult = producer.send(msg, 500);        // 发送消息，ref: sign_m_210
        System.out.printf("%s%n", sendResult);

        producer.shutdown();
    }
}
```


---
## 生产者-初始化
- `org.apache.rocketmq.client.producer.DefaultMQProducer`
```java
// sign_c_110
public class DefaultMQProducer extends ClientConfig implements MQProducer {

    // sign_cm_110
    public DefaultMQProducer(final String producerGroup) {
        this.producerGroup = producerGroup;
        defaultMQProducerImpl = new DefaultMQProducerImpl(this, null);  // ref: sign_cm_120
        produceAccumulator = ... .getOrCreateProduceAccumulator(this);  // ref: sign_cm_130
    }

    // sign_m_110
    @Override
    public void start() throws MQClientException {
        ...

        this.defaultMQProducerImpl.start(); // ref: sign_m_120
        this.produceAccumulator.start();    // ref: sign_m_130
        ...
    }
}
```

- `org.apache.rocketmq.client.impl.producer.DefaultMQProducerImpl`
  - 客户端实例初始化参考：[Admin-命令工具-初始化客户端 sign_cm_330](./Admin-命令工具.md#初始化客户端)
  - 客户端实例启动参考：[Admin-命令工具-初始化客户端 sign_m_330](./Admin-命令工具.md#初始化客户端)
```java
// sign_c_120
public class DefaultMQProducerImpl implements MQProducerInner {

    private MQClientInstance mQClientFactory;


    // sign_cm_120
    public DefaultMQProducerImpl(final DefaultMQProducer defaultMQProducer, RPCHook rpcHook) {
        ... // 记录参数为成员变量

        this.asyncSenderThreadPoolQueue = new LinkedBlockingQueue<>(50000);
        this.defaultAsyncSenderExecutor = new ThreadPoolExecutor(..., this.asyncSenderThreadPoolQueue, ...);
        ... // 初始化 Semaphore
        ... // 初始化失败策略
    }


    // sign_m_120
    public void start() throws MQClientException {
        this.start(true);   // ref: sign_m_121
    }

    // sign_m_121
    public void start(final boolean startFactory) throws MQClientException {
        switch (this.serviceState) {
            case CREATE_JUST:
                ...

                // 客户端实例初始化参考：[Admin-命令工具-初始化客户端 sign_cm_330]
                this.mQClientFactory = ... .getOrCreateMQClientInstance(this.defaultMQProducer, rpcHook);

                boolean registerOK = mQClientFactory.registerProducer(this.defaultMQProducer.getProducerGroup(), this);
                ... // 校验是否注册成功

                if (startFactory) { // true
                    mQClientFactory.start();    // 客户端实例启动参考：[Admin-命令工具-初始化客户端 sign_m_330]
                }

                this.initTopicRoute();          // topics 为 null，无实际操作

                this.mqFaultStrategy.startDetector();       // 启动 Detector 定时任务
                ... // log

                this.serviceState = ServiceState.RUNNING;   // 设置状态
                break;
            ... // 其他 case 处理
        }

        ...
    }
}
```

- `org.apache.rocketmq.client.producer.ProduceAccumulator`
```java
// sign_c_130
public class ProduceAccumulator {

    // sign_cm_130
    public ProduceAccumulator(String instanceName) {
        this.instanceName = instanceName;
        this.guardThreadForSyncSend = new GuardForSyncSendService(this.instanceName);
        this.guardThreadForAsyncSend = new GuardForAsyncSendService(this.instanceName);
    }
    
    // sign_m_130  启动发送线程
    void start() {
        guardThreadForSyncSend.start();
        guardThreadForAsyncSend.start();
    }
}
```


---
## 发消息
- `org.apache.rocketmq.client.producer.DefaultMQProducer`
```java
// sign_c_210
public class DefaultMQProducer extends ClientConfig implements MQProducer {

    // sign_m_210  发送消息
    @Override
    public SendResult send(Message msg, long timeout) throws ... {
        msg.setTopic(withNamespace(msg.getTopic()));
        return this.defaultMQProducerImpl.send(msg, timeout);   // 发送消息，ref: sign_m_220
    }
}
```

- `org.apache.rocketmq.client.impl.producer.DefaultMQProducerImpl`
```java
// sign_c_220
public class DefaultMQProducerImpl implements MQProducerInner {

    // sign_m_220  发送消息
    public SendResult send(Message msg, long timeout) throws ... {
        return this.sendDefaultImpl(msg, CommunicationMode.SYNC, null, timeout);    // ref: sign_m_211
    }

    // sign_m_211  发送消息
    private SendResult sendDefaultImpl(
        Message msg,  CommunicationMode communicationMode,  SendCallback sendCallback,  long timeout
    ) throws ... {
        ... // 校验
        ...

        TopicPublishInfo topicPublishInfo = this.tryToFindTopicPublishInfo(msg.getTopic());
        if (topicPublishInfo != null && topicPublishInfo.ok()) {
            MessageQueue mq = null;
            SendResult sendResult = null;
            ...
            for (; times < timesTotal; times++) {
                ... // 重试处理

                MessageQueue mqSelected = this.selectOneMessageQueue(topicPublishInfo, lastBrokerName, resetIndex);
                if (mqSelected != null) {
                    mq = mqSelected;
                    ...
                    try {
                        ... // 校验是否超时

                        sendResult = this.sendKernelImpl(msg, mq, communicationMode, ...);
                        ...

                        this.updateFaultItem(mq.getBrokerName(), endTimestamp - beginTimestampPrev, false, true);
                        ... // 通信模式处理

                    } ...   // catch 
                } ...       // else
            }

            if (sendResult != null) {
                return sendResult;
            }
            
            ... // 组装异常
        }

        ...     // 组装异常
    }

    private TopicPublishInfo tryToFindTopicPublishInfo(final String topic) {
        TopicPublishInfo topicPublishInfo = this.topicPublishInfoTable.get(topic);
        if (null == topicPublishInfo || !topicPublishInfo.ok()) {
            this.topicPublishInfoTable.putIfAbsent(topic, new TopicPublishInfo());
            // 从命名服务更新 Topic 路由信息 (填充 Broker 信息)
            this.mQClientFactory.updateTopicRouteInfoFromNameServer(topic);
            topicPublishInfo = this.topicPublishInfoTable.get(topic);
        }

        if (topicPublishInfo.isHaveTopicRouterInfo() || topicPublishInfo.ok()) {
            return topicPublishInfo;
        } ... // else
    }
}
```