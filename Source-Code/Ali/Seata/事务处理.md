# Seata-事务处理


---
## 调用源
- 参考：[AOP-注解处理-处理实现 sign_cb_231](./AOP-注解处理.md#处理实现)


---
## 事务处理
- `io.seata.tm.api.TransactionalTemplate`
```java
// sign_c_110  事务处理模板
public class TransactionalTemplate {
    
    // sign_m_110  事务模板执行
    public Object execute(TransactionalExecutor business) throws Throwable {
        // 1. Get transactionInfo
        TransactionInfo txInfo = business.getTransactionInfo();
        ...
        // 1.1 获取当前事务，如果不是 null，则 tx 角色为参与者: 'GlobalTransactionRole.Participant'.
        GlobalTransaction tx = GlobalTransactionContext.getCurrent();

        // 1.2 处理事务传播。
        Propagation propagation = txInfo.getPropagation();
        SuspendedResourcesHolder suspendedResourcesHolder = null;
        try {
            switch (propagation) {
                case NOT_SUPPORTED: // 不支持（当前若有则挂着）
                    if (existingTransaction(tx)) { // 存在事务
                        suspendedResourcesHolder = tx.suspend(false); // 挂起
                    }
                    return business.execute(); // 执行业务代码
                case REQUIRES_NEW:  // 需要新的（当前若有则挂着，并创建新的）
                    // If transaction is existing, suspend it, and then begin new transaction.
                    if (existingTransaction(tx)) {
                        suspendedResourcesHolder = tx.suspend(false);
                    }
                    tx = GlobalTransactionContext.createNew(); // 创建新的事务
                    break;
                case SUPPORTS:      // 支持（有就用，没有也不创建）
                    // If transaction is not existing, execute without transaction.
                    if (notExistingTransaction(tx)) {
                        return business.execute();
                    }
                    // Continue and execute with new transaction
                    break;
                case REQUIRED:      // 需要（用当前或创建新的）
                    // If current transaction is existing, execute with current transaction,else create
                    tx = GlobalTransactionContext.getCurrentOrCreate();
                    break;
                case NEVER:         // 从不（绝不能有）
                    // If transaction is existing, throw exception.
                    if (existingTransaction(tx)) {
                        throw new TransactionException(...);
                    } else {
                        // Execute without transaction and return.
                        return business.execute();
                    }
                case MANDATORY:     // 强制（绝不能没有）
                    // If transaction is not existing, throw exception.
                    if (notExistingTransaction(tx)) {
                        throw new TransactionException("No existing transaction found for transaction marked with propagation 'mandatory'");
                    }
                    // Continue and execute with current transaction.
                    break;
                default:
                    throw new TransactionException("Not Supported Propagation:" + propagation);
            }

            // set current tx config to holder
            GlobalLockConfig previousConfig = replaceGlobalLockConfig(txInfo);
            ...

            try {
                // 2. If the tx role is 'GlobalTransactionRole.Launcher', send the request of beginTransaction to TC,
                //    else do nothing. Of course, the hooks will still be triggered.
                beginTransaction(txInfo, tx);

                Object rs;
                try {
                    // Do Your Business
                    rs = business.execute();
                } ... // catch

                // 4. everything is fine, commit.
                commitTransaction(tx, txInfo);
                return rs;
            }
            ... // finally { }
        } 
        ... // finally { }
    }

}
```