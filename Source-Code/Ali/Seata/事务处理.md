# Seata-事务处理


---
## 调用源
- 参考：[AOP-注解处理-处理实现 sign_cb_231](./AOP-注解处理.md#处理实现)


---
## 事务处理
- `io.seata.tm.api.TransactionalTemplate`
```java
// sign_c_110  事务处理模板
public class TransactionalTemplate {
    
    // sign_m_110  事务模板执行
    public Object execute(TransactionalExecutor business) throws Throwable {
        // 1. Get transactionInfo
        TransactionInfo txInfo = business.getTransactionInfo();
        ...
        // 1.1 获取当前事务，如果不是 null，则 tx 角色为参与者: 'GlobalTransactionRole.Participant'.
        GlobalTransaction tx = GlobalTransactionContext.getCurrent();

        // 1.2 处理事务传播。
        Propagation propagation = txInfo.getPropagation();
        SuspendedResourcesHolder suspendedResourcesHolder = null;
        try {
            switch (propagation) {
                case NOT_SUPPORTED: // 不支持（当前若有则挂着）
                    if (existingTransaction(tx)) { // 存在事务
                        suspendedResourcesHolder = tx.suspend(false); // 挂起
                    }
                    return business.execute(); // 执行业务代码，并返回
                case REQUIRES_NEW:  // 需要新的（当前若有则挂着，并创建新的）
                    if (existingTransaction(tx)) {
                        suspendedResourcesHolder = tx.suspend(false); // 挂起
                    }
                    tx = GlobalTransactionContext.createNew(); // 创建新的事务
                    break;
                case SUPPORTS:      // 支持（有就用，没有也不创建）
                    if (notExistingTransaction(tx)) {
                        return business.execute(); // 执行业务代码，并返回
                    }
                    // 继续并执行当前事务
                    break;
                case REQUIRED:      // 需要（用当前或创建新的）
                    // 如果当前事务存在，则使用当前事务执行，否则创建新的
                    tx = GlobalTransactionContext.getCurrentOrCreate();
                    break;
                case NEVER:         // 从不（绝不能有）
                    if (existingTransaction(tx)) { // 存在事务的话，就抛异常
                        throw new TransactionException(...);
                    } else {
                        return business.execute(); // 执行业务代码，并返回
                    }
                case MANDATORY:     // 强制（绝不能没有）
                    if (notExistingTransaction(tx)) { // 不存在事务的话，就抛异常
                        throw new TransactionException(...);
                    }
                    // 继续并执行当前事务
                    break;
                ...
            }

            ...

            try {
                // 2. 如果 tx 角色是‘GlobalTransactionRole.Launcher’，则向 TC 发送 beginTransaction 请求，
                beginTransaction(txInfo, tx);

                Object rs;
                try {
                    rs = business.execute(); // 执行业务代码
                } ... // catch

                // 4. 全部完成，提交事务
                commitTransaction(tx, txInfo);
                return rs;
            }
            ... // finally { }
        } 
        ... // finally { }
    }

}
```