# Dubbo-服务发现


---
## 调用栈
- **获取服务实例--创建 ref 时调用**
```js
// org.apache.dubbo.registry.nacos.NacosServiceDiscovery #getInstances(String serviceName)
// new RuntimeException("栈跟踪-1").printStackTrace()

java.lang.RuntimeException: 栈跟踪-1
    at org.apache.dubbo.registry.nacos.NacosServiceDiscovery.getInstances(NacosServiceDiscovery.java:151)
    at org.apache.dubbo.registry.client.ServiceDiscoveryRegistry.subscribeURLs(ServiceDiscoveryRegistry.java:351)
    at org.apache.dubbo.registry.client.ServiceDiscoveryRegistry.doSubscribe(ServiceDiscoveryRegistry.java:243) // 订阅处理，ref: sign_m_110
    at org.apache.dubbo.registry.client.ServiceDiscoveryRegistry.subscribe(ServiceDiscoveryRegistry.java:194)
    at org.apache.dubbo.registry.ListenerRegistryWrapper.subscribe(ListenerRegistryWrapper.java:87)
    at org.apache.dubbo.registry.integration.DynamicDirectory.subscribe(DynamicDirectory.java:186)
    at org.apache.dubbo.registry.client.ServiceDiscoveryRegistryDirectory.subscribe(ServiceDiscoveryRegistryDirectory.java:151)
    at org.apache.dubbo.registry.integration.RegistryProtocol.doCreateInvoker(RegistryProtocol.java:639)
    at org.apache.dubbo.registry.integration.InterfaceCompatibleRegistryProtocol.getServiceDiscoveryInvoker(InterfaceCompatibleRegistryProtocol.java:66)
    at org.apache.dubbo.registry.client.migration.MigrationInvoker.refreshServiceDiscoveryInvoker(MigrationInvoker.java:458)
    at org.apache.dubbo.registry.client.migration.MigrationInvoker.migrateToApplicationFirstInvoker(MigrationInvoker.java:256)
    at org.apache.dubbo.registry.client.migration.MigrationRuleHandler.refreshInvoker(MigrationRuleHandler.java:78)
    at org.apache.dubbo.registry.client.migration.MigrationRuleHandler.doMigrate(MigrationRuleHandler.java:62)
    at org.apache.dubbo.registry.client.migration.MigrationRuleListener.onRefer(MigrationRuleListener.java:285)
    at org.apache.dubbo.registry.integration.RegistryProtocol.interceptInvoker(RegistryProtocol.java:602)
    at org.apache.dubbo.registry.integration.RegistryProtocol.doRefer(RegistryProtocol.java:566)
    at org.apache.dubbo.registry.integration.RegistryProtocol.refer(RegistryProtocol.java:547)
    at org.apache.dubbo.rpc.protocol.ProtocolSecurityWrapper.refer(ProtocolSecurityWrapper.java:112)
    at org.apache.dubbo.rpc.protocol.ProtocolListenerWrapper.refer(ProtocolListenerWrapper.java:84)
    at org.apache.dubbo.rpc.cluster.filter.ProtocolFilterWrapper.refer(ProtocolFilterWrapper.java:72)
    at org.apache.dubbo.rpc.protocol.ProtocolSerializationWrapper.refer(ProtocolSerializationWrapper.java:55)
    at org.apache.dubbo.rpc.protocol.InvokerCountWrapper.refer(InvokerCountWrapper.java:48)
    at org.apache.dubbo.rpc.Protocol$Adaptive.refer(Protocol$Adaptive.java)
    at org.apache.dubbo.config.ReferenceConfig.createInvoker(ReferenceConfig.java:656)
    at org.apache.dubbo.config.ReferenceConfig.createProxy(ReferenceConfig.java:486)
    at org.apache.dubbo.config.ReferenceConfig.init(ReferenceConfig.java:369)
    at org.apache.dubbo.config.ReferenceConfig.get(ReferenceConfig.java:238)
    at org.apache.dubbo.config.utils.SimpleReferenceCache.get(SimpleReferenceCache.java:140)
    at org.apache.dubbo.config.deploy.DefaultModuleDeployer.lambda$referServices$6(DefaultModuleDeployer.java:545)
    at java.base/java.util.concurrent.ConcurrentHashMap$ValuesView.forEach(ConcurrentHashMap.java:4780)
    at org.apache.dubbo.config.deploy.DefaultModuleDeployer.referServices(DefaultModuleDeployer.java:517)
    at org.apache.dubbo.config.deploy.DefaultModuleDeployer.startSync(DefaultModuleDeployer.java:183)
    at org.apache.dubbo.config.deploy.DefaultModuleDeployer.start(DefaultModuleDeployer.java:156)
    at org.apache.dubbo.config.spring.context.DubboDeployApplicationListener.onContextRefreshedEvent(DubboDeployApplicationListener.java:157)
    at org.apache.dubbo.config.spring.context.DubboDeployApplicationListener.onApplicationEvent(DubboDeployApplicationListener.java:143)
    at org.apache.dubbo.config.spring.context.DubboDeployApplicationListener.onApplicationEvent(DubboDeployApplicationListener.java:52)
    ...
    at org.springframework.context.support.AbstractApplicationContext.refresh(AbstractApplicationContext.java:586)
    at org.springframework.context.annotation.AnnotationConfigApplicationContext.<init>(AnnotationConfigApplicationContext.java:93)
    at org.apache.dubbo.demo.consumer.Application.main(Application.java:35)
```

- **获取所有服务--退出应用时才调用**
```js
// org.apache.dubbo.registry.nacos.NacosServiceDiscovery #getServices()
// new RuntimeException("栈跟踪-2").printStackTrace()

java.lang.RuntimeException: 栈跟踪-2
    at org.apache.dubbo.registry.nacos.NacosServiceDiscovery.getServices(NacosServiceDiscovery.java:143)
    ...
    at org.apache.dubbo.rpc.model.ScopeModel.destroy(ScopeModel.java:122)
    at org.apache.dubbo.config.DubboShutdownHook.doDestroy(DubboShutdownHook.java:142)
    at org.apache.dubbo.config.DubboShutdownHook.run(DubboShutdownHook.java:82)
```

- URL--客户端解析出 Ref 时的配置信息
```js
consumer://10.32.50.94/org.apache.dubbo.demo.DemoService  ?
    application=dubbo-demo-annotation-consumer  &
    background=false  &
    category=providers,configurators,routers  &
    dubbo=2.0.2  &
    executor-management-mode=isolation  &
    file-cache=true  &
    interface=org.apache.dubbo.demo.DemoService  &
    methods=sayHello,sayHelloAsync  &
    pid=28208  &
    release=  &
    side=consumer  &
    sticky=false  &
    timestamp=1717467894291  &
    unloadClusterRelated=false
```


---
## 原理
### 发现与订阅
- `org.apache.dubbo.registry.client.ServiceDiscoveryRegistry`
```java
// sign_c_110
public class ServiceDiscoveryRegistry extends FailbackRegistry {

    // sign_m_110  订阅处理
    @Override
    public void doSubscribe(URL url, NotifyListener listener) {
        ...

        // 接口类对应的服务名 (org.apache.dubbo.demo.DemoService -> dubbo-demo-annotation-provider)
        Set<String> mappingByUrl = ServiceNameMapping.getMappingByUrl(url); // 从 URL 中获取
        ...

        if (mappingByUrl == null) {
            ...
            try {
                mappingByUrl = serviceNameMapping.getMapping(url);  // 从 URL 或缓存中获取
                try {
                    MappingListener mappingListener = new DefaultMappingListener(..., listener);
                    // serviceNameMapping 为 MetadataServiceNameMapping 实例，ref: sign_c_130
                    mappingByUrl = serviceNameMapping.getAndListen(this.getUrl(), url, mappingListener);    // 从配置中心读取，ref: sign_m_120
                    ...
                }
                ... // catch
                ... // log
            } 
            ... // finally
        }
        subscribeURLs(url, listener, mappingByUrl); // 订阅服务，ref: sign_m_111
    }

    // sign_m_111  订阅服务
    protected void subscribeURLs(URL url, NotifyListener listener, Set<String> serviceNames) {
        ...

        try {
            ...
                ...

                // serviceNames: [dubbo-demo-annotation-provider]
                for (String serviceName : serviceNames) {
                    List<ServiceInstance> serviceInstances = serviceDiscovery.getInstances(serviceName);    // 获取实例，ref: sign_m_160
                    if (CollectionUtils.isNotEmpty(serviceInstances)) {
                        serviceInstancesChangedListener.onEvent(
                            new ServiceInstancesChangedEvent(serviceName, serviceInstances)
                        );
                    }
                }

                ...
            ...
        }
        ... // finally
    }
}
```

#### 查找接口的服务名
- `org.apache.dubbo.metadata.AbstractServiceNameMapping`
```java
// sign_c_120
public abstract class AbstractServiceNameMapping implements ServiceNameMapping {

    // sign_m_120  获取服务名
    @Override
    public Set<String> getAndListen(URL registryURL, URL subscribedURL, MappingListener listener) {
        String key = ServiceNameMapping.buildMappingKey(subscribedURL);
        Set<String> mappingServices = mappingCacheManager.get(key); // 从缓存中再获取一次

        if (CollectionUtils.isEmpty(mappingServices)) {
            try {
                mappingServices = (new AsyncMappingTask(..., subscribedURL, ...)).call();   // ref: sign_c_121 | sign_m_121
            } 
            ... // catch
            ... // mappingServices 为空继续处理
            ... // mappingServices 不为空添加到缓存
        } 
        ... // else

        return mappingServices;
    }

    // sign_c_121
    private class AsyncMappingTask implements Callable<Set<String>> {

        // sign_m_121
        @Override
        public Set<String> call() throws Exception {
            synchronized (mappingListeners) {
                Set<String> mappedServices = emptySet();
                try {
                    // mappingKey 值为 org.apache.dubbo.demo.DemoService
                    String mappingKey = ServiceNameMapping.buildMappingKey(subscribedURL);
                    if (listener != null) {
                        mappedServices = toTreeSet(
                            getAndListen(subscribedURL, listener)   // ref: sign_m_130
                        );
                        ...
                    } 
                    ... // else
                } 
                ... // catch

                return mappedServices;
            }
        }
    }
}
```

- `org.apache.dubbo.registry.client.metadata.MetadataServiceNameMapping`
```java
// sign_c_130
public class MetadataServiceNameMapping extends AbstractServiceNameMapping {

    // sign_m_130
    @Override
    public Set<String> getAndListen(URL url, MappingListener mappingListener) {
        String serviceInterface = url.getServiceInterface();    // 值为 org.apache.dubbo.demo.DemoService
        String registryCluster = getRegistryCluster(url);       // 值为 default

        // metadataReport 为 NacosMetadataReport 实例，ref: sign_c_140
        MetadataReport metadataReport = metadataReportInstance.getMetadataReport(registryCluster);
        ... // 空处理

        return metadataReport.getServiceAppMapping(serviceInterface, mappingListener, url); // 获取服务名，ref: sign_m_140
    }
}
```

- `org.apache.dubbo.metadata.store.nacos.NacosMetadataReport`
```java
// sign_c_140
public class NacosMetadataReport extends AbstractMetadataReport {

    // sign_m_140  获取服务名
    @Override
    public Set<String> getServiceAppMapping(String serviceKey, MappingListener listener, URL url) {
        String group = DEFAULT_MAPPING_GROUP;
        ...

        // 服务名记录在配置内容里，key 是服务接口全称。serviceKey: org.apache.dubbo.demo.DemoService
        String content = getConfig(serviceKey, group);  // 读取配置内容，ref: sign_m_141
        return ServiceNameMapping.getAppNames(content);
    }

    // sign_m_141  读取配置内容
    private String getConfig(String dataId, String group) {
        try {
            return configService.getConfig(dataId, group);  // 获取配置内容，ref: sign_m_150
        }
        ... // catch 
    }
}
```

- `org.apache.dubbo.metadata.store.nacos.NacosConfigServiceWrapper`
```java
// sign_c_150
public class NacosConfigServiceWrapper {

    // Nacos API 接口：com.alibaba.nacos.api.config.ConfigService 实例
    private ConfigService configService;

    // sign_m_150  获取配置内容
    public String getConfig(String dataId, String group) throws NacosException {
        // 调用 Nacos API 获取配置内容
        return configService.getConfig(..., DEFAULT_TIMEOUT);
    }
}
```

#### 查找服务实例
- `org.apache.dubbo.registry.nacos.NacosServiceDiscovery`
```java
// sign_c_160
public class NacosServiceDiscovery extends AbstractServiceDiscovery {

    // sign_m_160  获取服务实例
    @Override
    public List<ServiceInstance> getInstances(String serviceName) throws NullPointerException {
        return ThrowableFunction.execute(
                namingService, 
                service -> service.selectInstances(serviceName, group, true)    // 查找服务实例，ref: sign_m_170
                        .stream()
                        .map((i) -> NacosNamingServiceUtils.toServiceInstance(registryURL, i))
                        .collect(Collectors.toList()));
    }
}
```

- `org.apache.dubbo.registry.nacos.NacosNamingServiceWrapper`
```java
// sign_c_170
public class NacosNamingServiceWrapper {

    // sign_m_170  查找服务实例
    public List<Instance> selectInstances(String serviceName, String group, boolean healthy) throws NacosException {
        return apply(
                () -> nacosConnectionManager.getNamingService() // 返回 Nacos API 客户端 NamingService 接口
                        .selectInstances(...(serviceName), group, healthy)  // 调用 API 获取服务实例
            );
    }
}
```