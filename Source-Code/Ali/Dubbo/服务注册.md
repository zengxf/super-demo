# Dubbo-服务注册


---
## 查看栈与参数
- `org.apache.dubbo.registry.nacos.NacosRegistry #doRegister(URL)`
  - `new RuntimeException("栈跟踪-1").printStackTrace();`
```js
java.lang.RuntimeException: 栈跟踪-1
    at *.registry.nacos.NacosRegistry.doRegister(NacosRegistry.java:177) // 服务注册
    at *.registry.support.FailbackRegistry.register(FailbackRegistry.java:223)
    at *.registry.ListenerRegistryWrapper.register(ListenerRegistryWrapper.java:61)
    at *.registry.integration.RegistryProtocol.lambda$register$1(RegistryProtocol.java:230)
    at *.metrics.event.MetricsEventBus.post(MetricsEventBus.java:76)
    at *.metrics.event.MetricsEventBus.post(MetricsEventBus.java:59)
    at *.registry.integration.RegistryProtocol.register(RegistryProtocol.java:223)
    at *.registry.integration.RegistryProtocol.access$1000(RegistryProtocol.java:140)
    at *.registry.integration.RegistryProtocol$ExporterChangeableWrapper.register(RegistryProtocol.java:1043)
    at *.registry.integration.RegistryProtocol$DestroyableExporter.register(RegistryProtocol.java:772)
    at *.config.ServiceConfig.register(ServiceConfig.java:365)
    at *.config.deploy.DefaultModuleDeployer.registerServiceInternal(DefaultModuleDeployer.java:494)
    at *.config.deploy.DefaultModuleDeployer.registerServices(DefaultModuleDeployer.java:431)
    at *.config.deploy.DefaultModuleDeployer.startSync(DefaultModuleDeployer.java:191)
    at *.config.deploy.DefaultModuleDeployer.start(DefaultModuleDeployer.java:156)
    at *.config.spring.context.DubboDeployApplicationListener.onContextRefreshedEvent(DubboDeployApplicationListener.java:157)
    at *.config.spring.context.DubboDeployApplicationListener.onApplicationEvent(DubboDeployApplicationListener.java:143) // ref: sign_m_210
    at org.springframework.context.event.SimpleApplicationEventMulticaster.doInvokeListener(SimpleApplicationEventMulticaster.java:176)
    ... // Spring 上下文刷新
    at org.apache.dubbo.demo.provider.Application.main(Application.java:29)
```

- URL
```js
dubbo://10.32.50.94:20880/org.apache.dubbo.demo.DemoService  ?
    application=dubbo-demo-annotation-provider  &
    deprecated=false  &
    dubbo=2.0.2  &
    dynamic=true  &
    generic=false  &
    interface=org.apache.dubbo.demo.DemoService  &
    methods=sayHello,sayHelloAsync  &
    prefer.serialization=fastjson2,hessian2  &
    service-name-mapping=true  &
    side=provider  &
    timestamp=1716777328287
```


---
## 调用原理
- `org.apache.dubbo.config.spring.context.DubboDeployApplicationListener`
```java
// sign_c_210  事件监听器
public class DubboDeployApplicationListener implements ApplicationListener<ApplicationContextEvent>, ... {

    //  sign_m_210  事件监听处理
    @Override
    public void onApplicationEvent(ApplicationContextEvent event) {
        if (nullSafeEquals(applicationContext, event.getSource())) {
            if (event instanceof ContextRefreshedEvent) {
                onContextRefreshedEvent((ContextRefreshedEvent) event); // ref: sign_m_211
            } 
            ... // else if
        }
    }

    // sign_m_211  上下文刷新处理
    private void onContextRefreshedEvent(ContextRefreshedEvent event) {
        ModuleDeployer deployer = moduleModel.getDeployer();
        Assert.notNull(deployer, ...);
        Object singletonMutex = LockUtils.getSingletonMutex(applicationContext);

        // 启动模块
        Future future = null;
        synchronized (singletonMutex) {
            future = deployer.start();
        }

        ... // 等待完成
    }

}
```

- `org.apache.dubbo.config.deploy.DefaultModuleDeployer`
```java
public class DefaultModuleDeployer extends AbstractDeployer<ModuleModel> implements ModuleDeployer {

    @Override
    public Future start() throws IllegalStateException {
        // 初始化
        applicationDeployer.initialize();
        return startSync();
    }

    private synchronized Future startSync() throws IllegalStateException {
        ... // 校验状态

        try {
            ...

            exportServices();               // 组装要注册的服务
            ...

            // 如果没有异步导出/引用服务，只需设置启动
            if (asyncExportingFutures.isEmpty() && asyncReferringFutures.isEmpty()) {
                onModuleStarted();          // 发布模块启动事件

                registerServices();         // 注册服务
                ...

                completeStartFuture(true);  // 设置 startFuture 状态为完成
            }
            ... // else
        }
        ... // catch

        return startFuture;
    }

    private void registerServices() {
        for (ServiceConfigBase sc : configManager.getServices()) {
            // 调用(刷新) 2 次，第 2 次才有数据，然后进来
            if (!Boolean.FALSE.equals(sc.isRegister())) {
                registerServiceInternal(sc);
            }
        }
        applicationDeployer.refreshServiceInstance();
    }

    private void registerServiceInternal(ServiceConfigBase sc) {
        ServiceConfig<?> serviceConfig = (ServiceConfig<?>) sc;
        ... // 校验
        sc.register(true);
    }
}
```

- `org.apache.dubbo.config.ServiceConfig`
```java
public class ServiceConfig<T> extends ServiceConfigBase<T> {

    @Override
    public void register(boolean byDeployer) {
        ... // 校验

        synchronized (this) {
            ... // DCL
            ... // 自动注册

            if (byDeployer) {
                for (Exporter<?> exporter : exporters.getOrDefault(*.AUTO_REGISTER_BY_DEPLOYER, *.emptyList())) {
                    exporter.register();
                }
            }
        }
    }

}
```

- `org.apache.dubbo.registry.integration.RegistryProtocol`
```java
// sign_c_240
public class RegistryProtocol implements Protocol, ScopeModelAware {

    // sign_c_241
    private static class DestroyableExporter<T> implements Exporter<T> {

        @Override
        public void register() {
            // exporter 为 ExporterChangeableWrapper 实例，ref: sign_c_242
            exporter.register(); // ref: sign_m_242
        }
    }

    // sign_c_242
    private class ExporterChangeableWrapper<T> implements Exporter<T> {

        // sign_m_242
        @Override
        public void register() {
            if (registered.compareAndSet(false, true)) {
                URL registryUrl = getRegistryUrl(originInvoker);
                Registry registry = getRegistry(registryUrl);
                RegistryProtocol.register(registry, getRegisterUrl()); // ref: sign_cb_240

                ...
            }
        }
    }

    // sign_cb_240
    private static void register(Registry registry, URL registeredProviderUrl) {
        ApplicationDeployer deployer = registeredProviderUrl.getOrDefaultApplicationModel().getDeployer();
        try {
            deployer.increaseServiceRefreshCount();
            ...

            MetricsEventBus.post(
                    RegistryEvent.toRsEvent(...),
                    () -> {
                        registry.register(registeredProviderUrl);
                        return null;
                    }
            );
        } finally {
            deployer.decreaseServiceRefreshCount();
        }
    }
}
```

- `org.apache.dubbo.registry.ListenerRegistryWrapper`
```java
public class ListenerRegistryWrapper implements Registry {

    @Override
    public void register(URL url) {
        try {
            if (registry != null) {
                registry.register(url);
            }
        } 
        ... // finally
    }
}
```

- `org.apache.dubbo.registry.support.FailbackRegistry`
```java
public abstract class FailbackRegistry extends AbstractRegistry {

    @Override
    public void register(URL url) {
        ...

        super.register(url);
        ...

        try {
            // 向服务器端发送注册请求
            doRegister(url);
        } 
        ... // catch
    }
}
```

- `org.apache.dubbo.registry.nacos.NacosRegistry`
```java
public class NacosRegistry extends FailbackRegistry {
    private final NacosNamingServiceWrapper namingService;

    @Override
    public void doRegister(URL url) {
        try {
            if (PROVIDER_SIDE.equals(url.getSide()) || ...) {   // url.getSide() 为 provider，进入此逻辑
                String serviceName = getServiceName(url);
                Instance instance = createInstance(url);
                
                namingService.registerInstance(
                    serviceName, 
                    getUrl().getGroup(Constants.DEFAULT_GROUP), // 默认为 DEFAULT_GROUP
                    instance
                );
            } 
            ... // else
        } 
        ... // catch
    }
}
```

- `org.apache.dubbo.registry.nacos.NacosNamingServiceWrapper`
```java
public class NacosNamingServiceWrapper {

    public void registerInstance(String serviceName, String group, Instance instance) throws NacosException {
        String nacosServiceName = handleInnerSymbol(serviceName);
        InstancesInfo instancesInfo = ConcurrentHashMapUtils.computeIfAbsent(
                registerStatus, new InstanceId(nacosServiceName, group), id -> new InstancesInfo());

        try {
            instancesInfo.lock();
            ... // 校验

            if (instancesInfo.getInstances().isEmpty()) {
                // directly register
                NamingService namingService = nacosConnectionManager.getNamingService();
                accept(() -> 
                    namingService.registerInstance(nacosServiceName, group, instance)
                );
                instancesInfo.getInstances().add(new InstanceInfo(instance, namingService));
                return;
            }

            ...

            ...
        } finally {
            instancesInfo.unlock();
        }
    }

    private void accept(NacosConsumer command) throws NacosException {
        NacosException le = null;
        int times = 0;
        for (; times < retryTimes + 1; times++) {
            try {
                command.accept();
                le = null;
                break;
            } 
            ... // catch
        }
        ...
    }
}
```